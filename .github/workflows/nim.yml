name: mumm
'on':
  workflow_dispatch: null
jobs:
  run_script:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the public repository
      - name: Checkout Public Repository
        uses: actions/checkout@v4

      # Step 2: Verify that secrets are available
      - name: Check if Secrets are Available
        run: |
          if [ -z "${{ secrets.PRIVATE_REPO_PAT }}" ]; then
            echo "âŒ Error: GitHub Secrets (PRIVATE_REPO_PAT) are not available in public repositories or forks!"
            exit 1
          fi
          echo "âœ… Secrets detected, continuing..."

      # Step 3: Fetch the private repository
      - name: Fetch Private Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO_NAME }}  # Name of the private repository
          token: ${{ secrets.PRIVATE_REPO_PAT }}        # Personal Access Token for private repo access
          path: private-config                          # Directory to clone the private repo into
          lfs: true                                     # Enable Git LFS support
          persist-credentials: true                     # Persist credentials for subsequent steps
          fetch-depth: 1                                # Shallow clone to speed up the process

      # Step 4: Debug Private Repository Content
      - name: Debug Private Repository Content
        run: |
          echo "[$(date)] ğŸ“‚ Contents of private-config directory:"
          ls -R private-config

      # Step 5: Install dependencies (yq, p7zip, dos2unix, unrar)
      - name: Install Dependencies
        run: |
          echo "[$(date)] ğŸ› ï¸ Installing dependencies..."
          sudo apt-get update -y
          sudo apt-get install -y p7zip-full dos2unix wget unrar
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
          echo "[$(date)] âœ… Dependencies installed successfully!"

      # Step 6: Run the private repository's script
      - name: Run Private Repository's Script
        run: |
          set -e  # Stop execution on any error
          trap "rm -f temp_script.sh" EXIT  # Clean up temporary files on exit

          CONFIG_FILE="private-config/.github/workflows/sus.yml"
          RAR_PASS="${{ secrets.PUBLIC_RAR_PASSWORD }}"  # Public repo's secret
          export RAR_PASS  # Export the secret as an environment variable

          # Check if the configuration file exists
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ Error: Configuration file '$CONFIG_FILE' not found! Ensure the file exists in the private repository."
            exit 1
          fi

          echo "[$(date)] âœ… Extracting 'run' commands from YAML..."
          yq eval '.jobs.run_script.steps[] | select(has("run")) | .run' "$CONFIG_FILE" > temp_script.sh

          echo "[$(date)] ğŸ“œ Script extraction complete. Contents are not logged for security reasons."

          # Escape special characters in RAR_PASS for sed
          escaped_rar_pass=$(printf '%s\n' "$RAR_PASS" | sed 's/[\/&]/\\&/g')

          # Adjust paths and insert secrets
          echo "[$(date)] ğŸ› ï¸ Adjusting paths and inserting secrets..."
          sed -i "s|\$RAR_PASS|${escaped_rar_pass}|g" temp_script.sh
          sed -i 's|yu.rar|./yu.rar|g' temp_script.sh
          sed -i 's|extracted/|./extracted/|g' temp_script.sh

          # Make the script executable and run it
          echo "[$(date)] ğŸš€ Running private repository's script..."
          chmod +x temp_script.sh
          ./temp_script.sh || {
            echo "âŒ Error: Private repository's script failed with exit code $?"
            exit 1
          }

          echo "[$(date)] âœ… Private repository's script executed successfully."

      # Step 7: Verify yu.rar exists after running the private script
      - name: Verify yu.rar Exists
        run: |
          echo "[$(date)] ğŸ”§ Verifying yu.rar..."
          if [ ! -f "./yu.rar" ]; then
            echo "âŒ Error: yu.rar not found after running the private repository's script!"
            echo "[$(date)] ğŸ” Listing all files in the workspace for debugging..."
            find . -type f
            exit 1
          fi
          ls -l ./yu.rar

          # Debugging: Test file integrity
          echo "[$(date)] ğŸ”§ Testing file integrity..."
          unrar t -p"$RAR_PASS" ./yu.rar || {
            echo "âŒ Error: yu.rar is corrupted or invalid."
            exit 1
          }

          echo "[$(date)] âœ… yu.rar verified successfully."

      # Step 8: Proceed with further processing (if needed)
      - name: Further Processing
        run: |
          echo "[$(date)] ğŸ‰ All steps completed successfully."
